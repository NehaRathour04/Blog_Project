{% extends "layout.html" %}

{% block content %}

<!-- Hero / Blog Header -->
<div>
  <a href="{% url 'home' %}" class="btn btn-outline-primary float-end">← All Blogs</a>
</div>

<section class="py-1 text-black border-bottom">
  <div class="container d-flex justify-content-between align-items-center">
    <div>
      <h1 class="display-4 fw-bold">{{ blog.title }}</h1>
      <p class="lead mb-0">
        By <strong>{{ blog.author }}</strong> • {{ blog.created_at|date:"F d, Y" }}
      </p>
    </div>
  </div>
</section>

{% if blog.banner_image %}
<div class="container my-4">
  <div class="mx-auto rounded overflow-hidden shadow-sm" style="max-width: 960px;">
    <div class="ratio ratio-16x9">
      <img src="{{ blog.banner_image.url }}" alt="Banner image" class="img-fluid" style="object-fit: cover;">
    </div>
  </div>
</div>
{% endif %}

<!-- Blog content -->
<section class="py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <article class="fs-5 lh-lg">
          {{ blog.content|linebreaks }}
        </article>
      </div>
    </div>
  </div>
</section>

<!-- Blog Images Slider -->
{% if blog.images.all %}
<div id="blogImagesCarousel" class="carousel slide" data-bs-ride="carousel">
  <!-- Indicators -->
  <div class="carousel-indicators">
    {% for image in blog.images.all|slice:":4" %}
      <button type="button" data-bs-target="#blogImagesCarousel" data-bs-slide-to="{{ forloop.counter0 }}"
              class="{% if forloop.first %}active{% endif %}" aria-current="{% if forloop.first %}true{% endif %}"
              aria-label="Slide {{ forloop.counter }}"></button>
    {% endfor %}
  </div>

  <!-- Slides -->
  <div class="carousel-inner">
    {% for image in blog.images.all|slice:":4" %}
      <div class="carousel-item {% if forloop.first %}active{% endif %}">
        <img src="{{ image.images.url }}" class="d-block w-100" alt="Blog Image {{ forloop.counter }}">
      </div>
    {% endfor %}
  </div>

  <!-- Controls with only icons -->
  <button class="carousel-control-prev" type="button" data-bs-target="#blogImagesCarousel" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#blogImagesCarousel" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
  </button>
</div>
{% endif %}

<!-- Comments Section -->
<section class="py-5 bg-light border-top">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">

        <h4 class="mb-4">Comments ({{ comments|length }})</h4>

        <!-- Comment form -->
        {% if user.is_authenticated %}
        <form method="post" action="{% url 'add_comment' blog.id %}" class="mt-4">
          {% csrf_token %}
          <div class="mb-3">
            <textarea name="content" rows="3" class="form-control" placeholder="Write a comment..."></textarea>
          </div>
          <button class="btn btn-primary">Post Comment</button>
        </form>
        {% else %}
        <div class="alert alert-info mt-4">
          <a href="{% url 'login' %}" class="alert-link">Log in</a> to add a comment.
        </div>
        {% endif %}

        <!-- Comments List -->
        {% if comments %}
        <ul class="list-unstyled">
          {% for comment in comments %}
          <li class="mt-4 pb-4 border-bottom position-relative">
            <div class="d-flex align-items-center mb-2">
              <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-3"
                   style="width:40px; height:40px;">
                {{ comment.user.username|first|upper }}
              </div>
              <div>
                <strong>{{ comment.user.username }}</strong><br>
                <small class="text-muted">{{ comment.created_at|date:"M d, Y • H:i" }}</small>
              </div>

              {% if user.is_authenticated and user.id == comment.user.id %}
              <!-- Edit & Delete buttons -->
              <div class="position-absolute top-0 end-0 d-flex gap-1 m-2">
                <!-- Edit button -->
                <button type="button" class="btn btn-sm btn-light text-primary"
                        onclick="document.getElementById('edit-form-{{ comment.id }}').classList.remove('d-none'); this.style.display='none';">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                    <path d="M12.146.854a.5.5 0 0 1 .708 0l2.292 2.292a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2L2 11.207V13h1.793L14 3.793 11.207 2zM12 1.5 13.5 3 12 4.5 10.5 3 12 1.5z"/>
                  </svg>
                </button>

                <!-- Delete button -->
                <button type="button" class="btn btn-sm btn-light text-danger"
                        onclick="if(confirm('Are you sure you want to delete this comment?')) {
                          window.location.href='{% url 'deleteComment' comment.id %}'; }">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                  </svg>
                </button>
              </div>
              {% endif %}
            </div>

            <!-- Comment text -->
            <p class="mb-0" id="comment-text-{{ comment.id }}">{{ comment.textcontent }}</p>

            <!-- Inline edit form -->
            {% if user.is_authenticated and user.id == comment.user.id %}
            <form method="post" action="{% url 'editComment' comment.id %}" class="d-none mt-2" id="edit-form-{{ comment.id }}">
              {% csrf_token %}
              <textarea name="content" class="form-control" rows="2">{{ comment.textcontent }}</textarea>
              <div class="mt-1">
                <button class="btn btn-sm btn-primary">Save</button>
                <button type="button" class="btn btn-sm btn-secondary"
                        onclick="document.getElementById('edit-form-{{ comment.id }}').classList.add('d-none');">
                  Cancel
                </button>
              </div>
            </form>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted">No comments yet. Be the first to comment!</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>

{% endblock %}
